
{% block content %}
<div class="container py-3">
  <h3 class="mb-3">出差行事曆 / 申請</h3>

  <div class="row g-3">
    <!-- 申請表單 -->
    <div class="col-lg-4">
      <div class="card shadow-sm">
        <div class="card-body">
          <h5 class="card-title mb-3">新出差申請</h5>
          <form method="post" action="{{ url_for('trips_page_or_create') }}">
            <div class="mb-2">
              <label class="form-label">國家（ISO2）</label>
              <input name="country" class="form-control" value="KR" placeholder="KR / TW / JP / US" required>
            </div>
            <div class="mb-2">
              <label class="form-label">地區</label>
              <input name="region" class="form-control" placeholder="Seoul / Taipei 等">
            </div>
            <div class="mb-2">
              <label class="form-label">城市</label>
              <input name="city" class="form-control" placeholder="城市（可空白）">
            </div>
            <div class="row">
              <div class="col-6 mb-2">
                <label class="form-label">開始日期</label>
                <input type="date" name="start_date" class="form-control" required>
              </div>
              <div class="col-6 mb-2">
                <label class="form-label">結束日期</label>
                <input type="date" name="end_date" class="form-control" required>
              </div>
            </div>
            <div class="mb-2">
              <label class="form-label">目的</label>
              <input name="purpose" class="form-control" placeholder="展會 / 客訪 / 教學等">
            </div>
            <button class="btn btn-primary w-100 mt-2" type="submit">送出出差申請</button>
            <div class="form-text mt-2">
              審核通過後，系統會自動將出差期間的<strong>週末與國定假日</strong>折算為補休（COMP）。
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- 行事曆 -->
    <div class="col-lg-8">
      <div class="card shadow-sm">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h5 class="card-title mb-0">行事曆</h5>
            <div class="d-flex align-items-center gap-2">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="mineOnly">
                <label class="form-check-label" for="mineOnly">只看我的</label>
              </div>
              <select id="holidayCountry" class="form-select form-select-sm" style="width:auto">
                <option value="KR" selected>KR</option>
                <option value="TW">TW</option>
                <option value="JP">JP</option>
                <option value="US">US</option>
              </select>
            </div>
          </div>
          <div id="calendar"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- FullCalendar（CDN） -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
  const calendarEl = document.getElementById('calendar');
  let holidaysLoaded = false;

  const calendar = new FullCalendar.Calendar(calendarEl, {
    initialView: 'dayGridMonth',
    height: 700,
    eventSources: [
      {
        id: 'trips',
        url: () => {
          const mine = document.getElementById('mineOnly').checked ? '1' : '0';
          return `/api/trips?mine=${mine}`;
        },
        method: 'GET'
      }
    ],
    eventDidMount(info) {
      // 國定假日事件上色
      if (info.event.source && info.event.source.id === 'holidays') {
        info.el.style.backgroundColor = '#FEF3C7';
        info.el.style.borderColor = '#F59E0B';
      }
    }
  });

  function loadHolidays() {
    if (calendar.getEventSourceById('holidays')) {
      calendar.getEventSourceById('holidays').remove();
    }
    const year = calendar.getDate().getFullYear();
    const c = document.getElementById('holidayCountry').value;
    calendar.addEventSource({
      id: 'holidays',
      url: `/api/holidays?country=${c}&year=${year}`,
      method: 'GET'
    });
    holidaysLoaded = true;
  }

  calendar.render();
  loadHolidays();

  document.getElementById('mineOnly').addEventListener('change', () => {
    const s = calendar.getEventSourceById('trips');
    s && s.refetch();
  });

  document.getElementById('holidayCountry').addEventListener('change', loadHolidays);
});
</script>
{% endblock %}
